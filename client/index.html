<!DOCTYPE html> 
<html> 
	<head> 
	<title>My Page</title> 
	<meta name="viewport" content="width=device-width, initial-scale=1"> 
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.css" />
	<link rel="stylesheet" href="css/main.css" />
	<script type="text/javascript" src="http://code.jquery.com/jquery-1.7.1.min.js"></script>
	<script type="text/javascript" src="http://code.jquery.com/mobile/1.0/jquery.mobile-1.0.min.js"></script>
</head> 
<body> 

<!-- Start of first page -->
<div data-role="page" id="foo">

	<div data-role="header">
		<h1>G(host)</h1>
	</div><!-- /header -->

	<div data-role="content">	
		<p>Welcome to (G)host, the kewlest game around, <span id="username">bro</span></p>
		<a href="#create" data-role="button" class="without-profile">Create a profile</a>
		<a href="#login" data-role="button" class="without-profile">Login</a>
		<a href="#start" data-role="button" class="with-profile">Start game!</a>
		<a href="#join" data-role="button" class="with-profile">Join game!</a>
		<a href="#continue" data-role="button" class="with-profile">Continue games</a>
		<a href="#profile" data-role="button" class="with-profile" id="view-profile">View profile/stats</a>
		<a href="#foo" data-role="button" class="with-profile" id="logout">Logout</a>
	</div><!-- /content -->

	<div data-role="footer">
		<h4>(G)host</h4>
	</div><!-- /footer -->
</div><!-- /page -->


<!-- Start of create profile -->
<div data-role="page" id="create">

	<div data-role="header">
		<h1>Create a profile</h1>
	</div><!-- /header -->

	<div data-role="content">	
		<h2>Fill this shit out yo</h2>
		<h4 class="error" id="create-error"></h4>
        <form action="" method="get" id="register-form">
	      Username: <input type="text" name="username" />
	      Password: <input type="text" name="password" />
		  Email: <input type="text" name="email" />
		  Phone: <input type="text" name="phone" />
	      <input type="submit" value="Create profile" />
        </form>	
		<a href='#foo' data-role="button">Home</a>
	</div><!-- /content -->

	<div data-role="footer">
		<h4>(G)(host)</h4>
	</div><!-- /footer -->
</div><!-- /page -->


<!-- Start of login -->
<div data-role="page" id="login">

	<div data-role="header">
		<h1>Login</h1>
	</div><!-- /header -->

	<div data-role="content">	
		<h2>Fill this shit out yo</h2>
		<h4 class="error" id="login-error"></h4>
        <form action="" method="get" id="login-form">
	      Username: <input type="text" name="username" />
	      Password: <input type="text" name="password" />
	      <input type="submit" value="Login" />
        </form>	
        <a href="#create" data-role="button">Not yet registered?  Create a profile!</a>
		<a href='#foo' data-role="button">Home</a>
	</div><!-- /content -->

	<div data-role="footer">
		<h4>(G)(host)</h4>
	</div><!-- /footer -->
</div><!-- /page -->





<!-- Start of start game -->
<div data-role="page" id="start">

	<div data-role="header">
		<h1>Start a game</h1>
	</div><!-- /header -->

	<div data-role="content">	
		<h2>Are you ready to start???!?!</h2>
		<a href='#publicStart' data-role="button">Start a public game</a>
		<a href='#privateStart' data-role="button">Start a private game</a>		
		<a href='#foo' data-role="button">Home</a>
	</div><!-- /content -->

	<div data-role="footer">
		<h4>(G)(host)</h4>
	</div><!-- /footer -->
</div><!-- /page -->

<!-- Start of join game -->
<div data-role="page" id="join">

	<div data-role="header">
		<h1>Join a game</h1>
	</div><!-- /header -->

	<div data-role="content">	
		<h2>Find some losers to play with</h2>
		<ul data-role="listview" data-theme="c">
			<li><a href="#">Kyle - Disembodied spirit</a></li>
			<li><a href="#">Danny - Poltergeist</a></li>
			<li><a href="#">Pat - Apparition</a></li>
			<li><a href="#">Alex - dubGhost</a></li>
		</ul>
		<a href='#foo' data-role="button">Home</a>
	</div><!-- /content -->

	<div data-role="footer">
		<h4>G(host)</h4>
	</div><!-- /footer -->
</div><!-- /page -->


<!--> Start of view profile  -->
<div data-role="page" id="profile">
	
	<div data-role="header">
		<h1>Your Profile</h1>
	</div><!-- /header -->
	
	<div data-role="content">	
		<h4 class="error" id="view-profile-error"></h4>
		<h2 id="profile-username"></h2>
		<ul data-role="listview" data-theme="c">
			<li id="profile-email">Email: </li>
			<li id="profile-phone">Phone: </li>
		</ul>
		<a href='#foo' data-role="button">Home</a>
	</div><!-- /content -->

	<div data-role="footer">
		<h4>G(host)</h4>
	</div><!-- /footer -->
</div><!-- /page -->
<script>

var Game = {};

(function () {
	
Game.SERVER_URL = 'http://127.0.0.1:1337';

Game.Credentials = (function () {

  var me = {},
           _userId,
           _username,
           _error;

  me.getUserId = function () {
    return _userId;
  };

  me.getUsername = function () {
    return _username;
  };

  me.getError = function () {
    return _error;
  };

  me.checkCredentials = function () {
	
	_userId = window.localStorage.getItem('userId');
	_username = window.localStorage.getItem('username');
	// If there's not a user ID, only show create/login options.
    if(!_userId) {
      $('.with-profile').hide();
      $('.without-profile').show();
    } else {
	  // If there is a user ID, show gameplay options.
      $('.with-profile').show();
      $('.without-profile').hide();
      // Personalize the page w/ the username.
	  $('#username').text(_username);
    }

  };

  me.setCredentials = function(response) {
	
	$('.error').hide();
  	if(response.e === 0) {
  	  if(response.userId) {
  	    window.localStorage.setItem('userId', response.userId);
  	    window.localStorage.setItem('username', response.username);
  	  } else {
  		window.localStorage.removeItem('userId');
  		window.localStorage.removeItem('username');
  	  }
  	  window.location = '#foo';
  	  this.checkCredentials();
  	} else {
  	  // If there's a server-side error, show it.
  	  _error = response.msg;
  	  $('#' + response.request + '-error').text(_error).show();
  	}
  };

  me.logout = function() {

    // Clear out previous user's info
  	me.setCredentials({e:0});
  	Game.User.setUser(null);
    $('#username').text('bro');
	$('#profile-username').text('');
	$('#profile-email').text('');
	$('#profile-phone').text('');
	$('input:text').val('');
	
	window.location = '#foo';

  };

  return me;

}());


Game.User = (function() {

  var me = {},
      _user,
      _error;

  me.getUser = function () {
    return _user;
  };

  me.setUser = function (userObject) {
    _user = userObject;
  };

  me.userResponseHandler = function (response) {

	if(response.e === 0) {
	  this.setUser(response.user);
	  this.viewProfile();
	} else {
	  _error = response.msg;
	  $('.error').hide();
	  $('#' + response.request + '-error').text(_error).show();
	}
  };

  me.viewProfile = function () {
	
	if(_user) {
	  $('#profile-username').text(_user.username);
	  $('#profile-email').text('Email: ' + _user.email);
	  $('#profile-phone').text('Phone: ' + _user.phone);
	} else {
	  Game.Ajax.getUserInfo();
	}
  };

  return me;

}());


Game.Ajax = (function() {

  var me = {},
      _user;

  me.create = function (formData) {
	console.log('create');
	$.ajax({
	  type: "GET",
	  dataType: "jsonp",
	  jsonpCallback: "Game.Credentials.setCredentials",
	  url: Game.SERVER_URL + "/user/create",
	  data: formData,
	});

  };
    
  me.login = function (formData) {
	console.log('login');
    $.ajax({
	  type: "GET",
	  dataType: "jsonp",
	  jsonpCallback: "Game.Credentials.setCredentials",
	  url: Game.SERVER_URL + "/user/authenticate",
	  data: formData,
    });

  };

  me.getUserInfo = function () {
	console.log('getuserinfo');
    $.ajax({
	  type: "GET",
	  dataType: "jsonp",
	  jsonpCallback: "Game.User.userResponseHandler",
	  url: Game.SERVER_URL + "/user/retrieve",
	  data: {_id: Game.Credentials.getUserId()},
    });

  };

  me.setupEvents = function () {

	// Set up submit handler for creation form
	$('#register-form').submit(function() {
	  Game.Ajax.create($(this).serialize());
	  return false;
	});
  
	// Set up submit handler for login form
	$('#login-form').submit(function() {
	  Game.Ajax.login($(this).serialize());
	  return false;
	});	

    // Set up page handler for Profile page display
    $('#profile').live('pageshow',function(event){
	  Game.User.viewProfile();
	});

    // Set up click handler for logout button
	$('#logout').click(function() {
      Game.Credentials.logout();
	});

  };

  return me;

}());

$(function () {

  Game.Ajax.setupEvents();
  Game.Credentials.checkCredentials();

});

}());

</script>

</body>
</html>
